# StonyGrey.ObjectMapper

StonyGrey.ObjectMapper is a source generator that maps objects to/ from [Protocol Buffers](https://developers.google.com/protocol-buffers) (Protobuf).

Given a protobuf definition such as this:

```protobuf
package Protobuf;

enum TestEnum { One = 0; Two = 1; }

message TestMessage {
    string String = 1;
    int32 Int = 2;
    optional int32 Optional = 3;
    int32 NonOptional = 4;
    bytes Guid = 5;
    sint64 DateTime = 6;
    oneof OneOf {
        sint64 OneOfA = 7;
        sint64 OneOfB = 8;
    }
    TestEnum TestEnum = 9;
    bytes Data = 10;
    optional bytes OptionalData = 11;
}
```

StonyGrey.ObjectMapper will create extension methods that map to and from the class created by [Grpc.Tools](https://www.nuget.org/packages/Grpc.Tools/) to your domain class. For example:

```csharp
namespace Domain
{
    public enum TestEnum { One, Two }

    public class TestMessage
    {
        public string? String { get; set; }
        public int Int { get; set; }
        public int? Optional { get; set; }
        public int NonOptional { get; set; }
        public long OneOfA { get; set; }
        public long OneOfB { get; set; }
        public DateTime DateTime { get; set; }
        public Guid Guid { get; set; }
        public TestEnum TestEnum { get; set; }
        public byte[] Data { get; set; } = Array.Empty<byte>();
        public byte[]? OptionalData { get; set; }
    }
}
```

## Usage
Please see the StonyGrey.ObjectMapper.Host project for a working example.

```csharp
using StonyGrey.ObjectMapper;
using Domain;

using System.Text.Json;
using System.Diagnostics;

[assembly: MapProtobuf(typeof(Domain.TestMessage), typeof(Protobuf.TestMessage))]
[assembly: MapProtobuf(typeof(Protobuf.TestMessage), typeof(Domain.TestMessage), ContainingNamespaceKind.Destination)]

var obj1 = new TestMessage()
{
    String = "abc",
    Int = 11,
    Optional = 22,
    OneOfA = 33,
    NonOptional = 44,
    DateTime = DateTime.Now,
    Guid = Guid.NewGuid(),
    TestEnum = TestEnum.Two,
    Data = new byte[] { 1, 2, 3, 4, 5, 6 },
    OptionalData = new byte[] { 7, 8 },
};

// MapToProtobuf & MapFromProtobuf were generated by the StonyGrey.ObjectMapper source generator.
// Look for them in StonyGrey.ObjectMapper.Host::Dependencies::Analyzers::StonyGrey.ObjectMapper::StonyGrey.ObjectMapper.MapGenerator
var pbObj1 = obj1.MapToProtobuf();

var obj2 = pbObj1.MapFromProtobuf();

var pbObj2 = obj2.MapToProtobuf();

Debug.Assert(string.Equals($"{JsonSerializer.Serialize(pbObj1)}", $"{JsonSerializer.Serialize(pbObj2)}", StringComparison.Ordinal));
Debug.Assert(string.Equals($"{JsonSerializer.Serialize(obj1)}", $"{JsonSerializer.Serialize(obj2)}", StringComparison.Ordinal));
```

## Notes

StonyGrey.ObjectMapper was built to address a specific problem and as such does not cover every scenario:
* Tested only with proto3
* In addition to [proto3 scalars](https://developers.google.com/protocol-buffers/docs/proto3#scalar), <code>byte[]</code>, <code>Guid</code> and <code>DateTime</code> will get mapped.
  * <code>byte[]</code> will map to <code>ByteString</code>
  * <code>Guid</code> will map to <code>ByteString</code>
  * <code>DateTime</code> will map to <code>sint64</code>
* [Enumerations](https://developers.google.com/protocol-buffers/docs/proto3#enum) will get mapped. A simple cast is used to convert and so, by convention, the numbering of enum values must match.
* [OneOf](https://developers.google.com/protocol-buffers/docs/proto3#oneof) and <code>optional</code> are supported.
* Most other features are unsupported/ untested, including 
  * <code>repeated</code> (i.e. collections)
  * [Nested Types](https://developers.google.com/protocol-buffers/docs/proto3#nested)
  * [Maps](https://developers.google.com/protocol-buffers/docs/proto3#maps) 
  * [Any](https://developers.google.com/protocol-buffers/docs/proto3#any)

StonyGrey.ObjectMapper will not descend an object graph. Just as with collections, if your class has a reference to another protobuf/ domain class, you will need to write some code to explicity map it.

## Acknowledgements

StonyGrey.ObjectMapper is based on the [InlineMapping](https://github.com/JasonBock/InlineMapping) project.
